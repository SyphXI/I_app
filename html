# screenshot_tool.py
#
# A command-line tool to automate taking screenshots from multiple devices,
# saving them into a timestamped folder, and generating an HTML gallery for easy viewing.
# This script is designed to be run from the command line and uses a config.ini
# file for settings, similar to the AppSpace Device Manager.

import os
import pandas as pd
import paramiko
import configparser
import logging
from pathlib import Path
from datetime import datetime

# --- 1. Setup Logging ---
# Configure logging to provide clear, informative output to the console.
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# --- 2. Configuration Management ---
def load_config():
    """
    Loads configuration from 'config.ini' or creates a default one if it doesn't exist.
    This is crucial for storing SSH credentials and file paths securely.
    """
    config = configparser.ConfigParser()
    config_file = 'config.ini'
    if not os.path.exists(config_file):
        logger.warning(f"'{config_file}' not found. Creating a default config file.")
        config['SSH'] = {
            'username': 'admin',
            'password': 'YourDevicePassword', # IMPORTANT: Change this!
            'timeout': '30'
        }
        config['PATHS'] = {
            'csv_file': 'Device Directory.csv'
        }
        with open(config_file, 'w') as f:
            config.write(f)
    else:
        config.read(config_file)
    return config

# --- 3. Screenshot and File Handling ---
def take_screenshot_and_save(device_name, ip_address, output_dir, ssh_config):
    """
    Connects to a device via SSH, takes a screenshot, and saves it.
    Returns a tuple of (filename, error_message).
    If successful, error_message will be None.
    If it fails, filename will be None and error_message will contain a description.
    """
    ssh_client = paramiko.SSHClient()
    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    
    try:
        # Connect to the device
        ssh_client.connect(
            hostname=ip_address,
            username=ssh_config['username'],
            password=ssh_config['password'],
            timeout=int(ssh_config['timeout'])
        )
        
        # Define the remote and local file paths
        remote_filename = f"/tmp/{device_name}_screenshot.png"
        local_filename = os.path.join(output_dir, f"{device_name}_screenshot.png")
        
        # Take the screenshot
        stdin, stdout, stderr = ssh_client.exec_command(f"scrot {remote_filename}")
        exit_status = stdout.channel.recv_exit_status()
        
        if exit_status != 0:
            error_output = stderr.read().decode('utf-8').strip()
            error_msg = f"Screenshot command failed with exit code {exit_status}. Error: {error_output}"
            logger.error(f"[{device_name}] {error_msg}")
            return None, error_msg

        # Transfer the file using SFTP
        sftp = ssh_client.open_sftp()
        sftp.get(remote_filename, local_filename)
        sftp.close()

        # Clean up the remote file
        ssh_client.exec_command(f"rm {remote_filename}")
        
        return local_filename, None
        
    except paramiko.AuthenticationException:
        error_msg = "Authentication failed. Check credentials in 'config.ini'."
        logger.error(f"[{device_name}] {error_msg}")
        return None, error_msg
    except paramiko.SSHException as e:
        error_msg = f"SSH connection failed: {e}"
        logger.error(f"[{device_name}] {error_msg}")
        return None, error_msg
    except Exception as e:
        error_msg = f"An unexpected error occurred: {e}"
        logger.error(f"[{device_name}] {error_msg}")
        return None, error_msg
    finally:
        ssh_client.close()

def generate_html_gallery(output_dir, screenshot_files, failed_devices_with_errors):
    """
    Generates a single HTML file to display the screenshots.
    This function now also includes cards for failed devices with their error messages.
    """
    html_content = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Device Screenshots</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
            .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
            .card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
            .card img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 10px; }
            .card h2 { margin: 0 0 10px 0; font-size: 1.2em; color: #333; }
            .error-card { background-color: #ffebeb; border: 1px solid #ff0000; }
            .error-message { padding: 10px; font-style: italic; color: #666; }
        </style>
    </head>
    <body>
        <h1>Device Screenshot Gallery</h1>
        <div class="gallery">
    """
    
    # Add cards for successful screenshots
    for filename in screenshot_files:
        device_name = os.path.basename(filename).replace('_screenshot.png', '')
        html_content += f"""
            <div class="card">
                <h2>{device_name}</h2>
                <img src="{os.path.basename(filename)}" alt="Screenshot of {device_name}">
            </div>
        """
        
    # Add cards for failed devices
    for device_name, error_msg in failed_devices_with_errors.items():
        html_content += f"""
            <div class="card error-card">
                <h2>{device_name}</h2>
                <p class="error-message">Error: {error_msg}</p>
            </div>
        """
    
    html_content += """
        </div>
    </body>
    </html>
    """
    
    # Save the HTML file
    with open(os.path.join(output_dir, 'index.html'), 'w') as f:
        f.write(html_content)

# --- 4. Main Execution Logic ---
def main():
    """
    Main function to orchestrate the entire process.
    """
    config = load_config()
    
    try:
        devices_df = pd.read_csv(config['PATHS']['csv_file'])
    except FileNotFoundError:
        logger.error(f"CSV file '{config['PATHS']['csv_file']}' not found. Please create it and try again.")
        return
        
    print("\n--- Available Devices ---")
    for i, row in devices_df.iterrows():
        print(f"{i+1}. {row['Device Name']} ({row['Device IP']})")
    
    selected_indices = input("\nEnter the device numbers to screenshot (e.g., 1,3,4) or 'all': ")
    
    if selected_indices.lower() == 'all':
        selected_devices = devices_df.to_dict('records')
    else:
        try:
            indices = [int(i.strip()) - 1 for i in selected_indices.split(',')]
            selected_devices = [devices_df.iloc[i] for i in indices]
        except (ValueError, IndexError):
            logger.error("Invalid input. Please enter a comma-separated list of valid numbers.")
            return

    if not selected_devices:
        logger.warning("No devices selected. Exiting.")
        return

    # Create a timestamped output directory
    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    output_dir = Path(f"screenshots_{timestamp}")
    output_dir.mkdir(exist_ok=True)

    logger.info(f"Starting screenshot process for {len(selected_devices)} selected device(s)...")
    logger.info(f"Screenshots will be saved in: {output_dir}")
    
    successful_screenshots = []
    failed_devices_with_errors = {}
    
    # Loop through selected devices and take screenshots
    for device in selected_devices:
        device_name = device['Device Name']
        ip_address = device['Device IP']
        
        filename, error_message = take_screenshot_and_save(device_name, ip_address, output_dir, config['SSH'])
        
        if filename:
            successful_screenshots.append(filename)
        else:
            failed_devices_with_errors[device_name] = error_message
    
    # Generate the HTML gallery, now passing the dictionary of failed devices
    generate_html_gallery(output_dir, successful_screenshots, failed_devices_with_errors)
    
    # Final summary
    logger.info("\n--- Screenshot Process Complete ---")
    logger.info(f"Successfully captured: {len(successful_screenshots)} screenshot(s).")
    if failed_devices_with_errors:
        logger.warning(f"Failed to capture for: {len(failed_devices_with_errors)} device(s). Check the generated 'index.html' for details.")
    logger.info(f"All files are located in: {output_dir}")
    logger.info("You can now share this folder or open the 'index.html' file to view the gallery.")


if __name__ == "__main__":
    main()
